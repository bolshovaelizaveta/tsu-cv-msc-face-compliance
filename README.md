# Проверка корректности фотографии лица (ICAO 9303 Compliance Check)

**ВКР Магистратура ТГУ 2026**  
**Автор:** Большова Е.А.  
**Направление:** Компьютерное зрение и нейронные сети
**Кейс:** Автоматическая проверка корректности фотографии лица при регистрации в Российской государственной библиотеке (РГБ) на соответствие стандартам ICAO 9303 и ISO/IEC 19794-5.

## Описание проекта
Данный сервис предназначен для автоматической оценки качества портретных фотографий. Система проверяет геометрию лица (ракурс) и вычисляет биометрическое качество изображения, что позволяет снизить количество некорректных фото в базе данных библиотеки без излишнего дискомфорта для пользователей. Используется каскадная фильтрация (фотометрия -> геометрия -> FIQA), что позволяет минимизировать нагрузку на сервер и обеспечивать высокую скорость отклика.

### Ключевые особенности:
- **Real-time Guidance:** Система «живых» подсказок в Web-интерфейсе помогает пользователю правильно позиционироваться перед камерой (ракурс, глаза, освещение).
- **Stateless Architecture:** Сервис не сохраняет персональные данные на диске, работая полностью в оперативной памяти (соответствие ФЗ-152).

## Технологический стек
*   **Backend:** FastAPI (Python 3.12)
*   **Computer Vision:** MediaPipe Face Mesh, PyTorch (MagFace iResNet50)
*   **Frontend:** HTML5, JavaScript (Capture API)
*   **Deployment:** Docker (поддержка x86_64 и ARM64/MPS)

## Установка и запуск (Docker)

Для запуска системы не требуется установка Python и библиотек на локальную машину. Весь стек, включая веса модели, упакован в Docker-образ.

1. **Клонирование репозитория:**
   ```bash
   git clone https://github.com/bolshovaelizaveta/tsu-cv-msc-face-compliance.git
   cd tsu-cv-msc-face-compliance
   ```

2. **Подготовка модели:**
    a. Скачайте оригинальные веса модели MagFace (`magface_iresnet50_MS1MV2.pth`) из [официального репозитория](https://github.com/IrvingMeng/MagFace).
    b. Разместите файл весов `magface_iresnet50_MS1MV2.pth` в директории `models/`.

3. **Сборка и запуск контейнера:**
   ```bash
   # Сборка под вашу архитектуру (на Apple Silicon используется --platform linux/arm64)
   docker build -t tsu-face-compliance .

   # Запуск сервиса
   docker run -p 8000:8000 tsu-face-compliance
   ```
---

## Использование

После запуска сервис доступен по адресу: **http://localhost:8000**

### 1. Web-интерфейс (Для операторов и пользователей)
Откройте корневой адрес в браузере. Вам будут доступны:
- Интерактивный помощник с живыми подсказками.
- Кнопка моментального снимка с вебкамеры.
- Модуль загрузки готовых файлов с диска.

### 2. API Документация (Swagger)
Для интеграции с внешними системами РГБ используйте эндпоинт `/validate`.  
Интерактивная документация: **http://localhost:8000/docs**

---

## Тестирование и результаты

Для глубокой оценки эффективности системы было проведено тестирование на репрезентативном наборе данных объемом **14 232 изображения** (на базе датасетов FFHQ и синтетических деградаций).

**Итоговые метрики:**
- **F1-Score:** 0.984
- **Precision (Точность):** 0.996
- **Recall (Полнота):** 0.973
- **Avg Latency:** 3.59 ms (Инференс на CPU Apple M4 Pro)

---

## Структура проекта

```text
tsu-cv-msc-face-compliance/
├── src/                # Логика валидации
│   ├── config.py       # Пороговые значения ICAO и пути
│   ├── geometry.py     # Анализ ракурса (PnP) и глаз (EAR)
│   └── quality.py      # FIQA (MagFace) и технические фильтры
├── research/           # Инструменты анализа и бенчмарки
│   ├── benchmark_engine.py  # Движок тестирования на 14к фото
│   ├── dataset_generator.py # Генератор синтетических дефектов
│   ├── clean_and_sort.py    # Утилита курирования данных 
│   └── thesis_plots.py      # Генератор графиков 
├── scripts/            # Сценарии демонстрации и проверки
│   ├── test_pipeline.py     # Демо-режим веб-камеры (CLI)
│   └── test_metrics.py      # Быстрая проверка метрик на 10 примерах
├── data/               # Наборы данных
│   └── test_samples/   # 10 контрольных снимков для тестов API
├── static/             # Web UI: Интерфейс регистрации в браузере
├── docs/                # Проектная документация
│   ├── HW_*.md          # Аналитические материалы (ТЗ, SWOT/PEST, стратегия данных)
│   └── results/         # Итоговые графики, дашборды и отчеты
├── main.py             # Запуск FastAPI сервера
├── Dockerfile          # Инструкция сборки контейнера
└── requirements.txt    # Список зависимостей проекта
```

## Лицензия
MIT License. Проект разработан в рамках магистерской диссертации ТГУ.