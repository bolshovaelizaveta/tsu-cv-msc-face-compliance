# Changelog

## [v0.1.0] - 2025-12-12 (MVP)

Реализован полный пайплайн проверки фотографий на соответствие стандартам ICAO 9303.

### Функционал 
- **API Сервис:** Асинхронный REST API на базе **FastAPI** (`main.py`) с эндпоинтом `/validate` для интеграции с внешними системами РГБ.
- **Геометрический анализ:** Модуль `src/geometry.py` на базе **MediaPipe Face Mesh** (468 точек).
  - Расчет углов поворота головы (Yaw, Pitch, Roll) через итеративный алгоритм **PnP (Perspective-n-Point)**.
  - **Исправлена инверсия осей:** Реализована корректная нормализация углов Эйлера для устранения ошибок в диапазоне Pitch при работе с мобильными камерами.
  - Адаптация матрицы камеры для корректной работы с портретными снимками высокого разрешения.
- **Оценка качества (FIQA):** Модуль `src/quality.py` на базе архитектуры **MagFace (iResNet50)**.
  - Использование нативного **PyTorch** для сохранения точности вычислений (FP32).
  - Поддержка аппаратного ускорения на **Apple Silicon (MPS)** и стандартных CPU (x86/ARM).
  - Расчет интегральной оценки качества (Quality Score) на основе магнитуды вектора признаков.
- **Модуль тестирования:** Добавлен скрипт `test_metrics.py` для автоматизированного расчета метрик точности.

### Технические решения
- **Препроцессинг:**
  - Реализована автоматическая коррекция ориентации изображения на основе EXIF-метаданных (через `Pillow`).
  - Добавлена конвертация цветовых пространств и нормализация входных тензоров согласно требованиям MagFace.
- **Конфигурация:**
  - Все пороговые значения (углы, качество) вынесены в `src/config.py`.
  - Установлены откалиброванные пороги для условий естественного освещения: Yaw/Pitch (20°), Quality Score (7.0).
- **Валидация на данных:**
  - **Сформирован контрольный датасет:** Собрана выборка из 10 снимков (`data/test_samples`), включающая эталонные фото (Compliant) и типичные нарушения (Bad Angle, Low Quality, No Face).

**Результаты тестирования:**
- **Precision:** 1.00
- **Recall:** 1.00
- **F1-Score:** 1.00
- **Avg Latency:** 21.16 ms
- **System FPS:** ~47.3

Примеры тестовых фотографий `data/test_samples` и лог результата `docs/results/testing_metrics`.

### Документация
- Добавлен `README.md` с инструкцией по развертыванию, описанием архитектуры и результатами бенчмарков.
- Сформирован `requirements.txt` с фиксированными версиями библиотек для воспроизводимости среды.
- Проект опубликован под открытой лицензией MIT.

## [v1.0.0] - 2025-12-20 (Research & Optimization)

Осуществлен переход от демонстрационного прототипа к полномасштабному исследованию устойчивости системы. Проведена калибровка алгоритмов под специфику массового обслуживания.

### Функционал 
- **Расширенный геометрический анализ:**
  - Реализован детектор состояния глаз на базе алгоритма **EAR (Eye Aspect Ratio)**.
  - Внедрена проверка на наличие множественных лиц в кадре (защита от ошибок регистрации и подмены субъекта).
  - Рефакторинг: переход к унифицированному методу `analyze()`, возвращающему полный контекст нарушений.
- **Интеллектуальная фотометрия:**
  - Добавлен детектор технического качества на базе **дисперсии Лапласиана** (эффективный отсев расфокусированных снимков).
  - Реализован предварительный фильтр освещенности для устранения аномалий FIQA-модели на экстремально темных снимках.

### Исследовательская работа 
- **Масштабирование:** Объем тестовой выборки увеличен с 10 до **14 232 изображений**.
- **Смена датасета:** Осуществлен переход с набора LFW на **FFHQ (Flickr-Faces-HQ)** для обеспечения соответствия анфас-стандартам ICAO.
- **Data Curation:** Реализован скрипт автоматизированной чистки исходных данных `clean_and_sort.py` для формирования эталонного датасета.
- **Синтетическая деградация:** Разработан движок управляемой деградации снимков (Blur, Rotation, Low Light) для поиска границ чувствительности алгоритмов.

### Технические решения и калибровка
- **Балансировка Recall/Precision:** Проведена серия экспериментов по подбору порогов. Финальные значения (Yaw: 20°, Quality: 9.0, Laplacian: 150) позволили достичь оптимального баланса между строгостью системы и лояльностью к пользователям.
- **Инклюзивность:** Проведено тестирование на лицах различной этнической принадлежности, подтвердившее отсутствие дискриминации по биометрическим признакам.
- **Производительность:** Среднее время инференса на CPU (Apple M4 Pro) доведено до **3.59 мс** за счет каскадной архитектуры.

### Документация и отчетность
- Добавлен пакет генерации научной графики: PR-кривая, Матрица классификации (Confusion Matrix), Boxplot задержек.
- Создан генератор презентационных дашбордов для визуализации вердиктов системы.


## [v1.2.0] - 2026-01-09 (Full-Stack Deployment & UX)

Проект переведен в статус готового к развертыванию программного решения. Реализована поддержка многосценарной работы (очной и удаленной) и система интерактивного взаимодействия с пользователем.

### Функционал 
- **Unified Web Interface:** Разработан полноценный Web-интерфейс (HTML5/JS), объединяющий два сценария регистрации:
  - Прямой захват и валидация видеопотока с веб-камеры.
  - Загрузка и проверка готовых файлов с локального диска.
- **Active Guidance System:** Реализована система «живых» подсказок в реальном времени. Система анализирует положение лица и выдает текстовые рекомендации («Поверните голову прямо», «Не закрывайте глаза», «Протрите камеру») до совершения финального снимка.
- **Backend Optimization:** Добавлен облегченный эндпоинт `/analyze_live` для высокочастотной обработки кадров (прерывание каскада на этапе геометрии без вызова тяжелых нейросетевых моделей).
- **Headless Mode:** Переход на библиотеку `opencv-python-headless` для корректной работы в серверных средах без графической оболочки.

### Технологии и Развертывание
- **Контейнеризация (Docker):** Проект полностью докеризирован. Создан самодостаточный (Self-contained) образ, включающий:
  - Системные графические зависимости (libgl1).
  - Веса нейросети MagFace.
  - Весь необходимый программный стек.
- **Кроссплатформенность:** Обеспечена поддержка сборки под архитектуры x86_64 и ARM64 (Apple Silicon / Rockchip).
- **Stateless Architecture:** Система приведена в соответствие с ФЗ-152 «О персональных данных» — обработка происходит в оперативной памяти без сохранения биометрических данных на диске.