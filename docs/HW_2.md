# Задание 2: Требования и уточнение задачи 

**Проект:** Система проверки валидности фотографии лица (Face Compliance Check) для регистрации в РГБ.

## 1. Функциональные требования

Система должна работать как REST API сервис, принимающий на вход изображение и возвращающий вердикт о его соответствии стандартам.

### 1.1. Обработка входных данных
*   Система должна принимать изображения в форматах JPEG, PNG, WEBP.
*   Система должна поддерживать изображения размером от 256x256 пикселей до 4096xs4096 пикселей.
*   Система должна автоматически приводить изображения к единому формату (RGB, ресайз) перед подачей в нейронные сети.

### 1.2. Детекция и анализ лица
*   **Детекция:** Система должна обнаруживать лица на изображении.
    *   Если найдено **0 лиц** → вернуть ошибку `no_face_detected`.
    *   Если найдено **>1 лица** → вернуть ошибку `multiple_faces_detected`.
*   **Геометрия:** Для найденного лица система должна вычислять углы поворота головы (Head Pose: Yaw, Pitch, Roll).
    *   Допустимый порог отклонения: **±15 градусов** по любой оси. При превышении → `head_pose_invalid`.
*   **Качество (FIQA):** Система должна оценивать резкость изображения (Blur score).
    *   Если оценка ниже порогового значения (определяется экспериментально, например, < 0.4) → `image_blurry`.
*   **Освещенность:** Система должна анализировать гистограмму яркости.
    *   Детекция пересветов (overexposure) и слишком темных фото (underexposure). При нарушении → `bad_lighting`.
*   **Атрибуты:** Система должна классифицировать наличие перекрытий лица:
    *   Солнцезащитные очки → `face_obscured`.
    *   Медицинские маски → `face_masked`.
    *   Закрытые глаза → `eyes_closed`.

### 1.3. Формирование ответа
*   Система должна возвращать JSON-структуру, содержащую:
    *   Общий статус (`is_valid`: bool).
    *   Список выявленных проблем (`errors`: list[str]).
    *   Координаты лица (`bbox`) для визуализации на клиенте.

---

## 2. Нефункциональные требования

### 2.1. Точность (Accuracy metrics)
*   **Face Detection Recall:** ≥ 0.99 (пропуск лица недопустим).
*   **Classification F1-score:** ≥ 0.85 (среднее гармоническое для классов: очки, маска, закрытые глаза).
*   **Head Pose Error (MAE):** ≤ 5 градусов (средняя абсолютная ошибка определения угла).
*   **False Rejection Rate (FRR):** ≤ 5% (не более 5 отказов на 100 идеальных фотографий).

### 2.2. Производительность 
*   **Задержка:** ≤ 1500 мс (1.5 сек) на одно изображение при обработке на CPU (без GPU ускорения).
*   **Пропускная способность:** Обработка последовательных запросов без утечек памяти.

### 2.3. Надежность и безопасность
*   **Stateless:** Сервис не должен сохранять загруженные фотографии на диск (обработка в оперативной памяти).
*   **Robustness:** Система не должна падать при загрузке битых файлов или файлов неверного формата (должна возвращать 400 Bad Request).

---

## 3. Интерфейсы 

### 3.1. API Endpoints
*   **Метод:** `POST /api/v1/validate`
*   **Входные данные (Request):** `multipart/form-data`, поле `file`.
*   **Выходные данные (Response 200 OK):**
    ```json
    {
      "is_valid": false,
      "errors": ["head_pose_invalid", "low_brightness"],
      "meta": {
        "face_bbox": [102, 50, 200, 250],
        "yaw": 25.4,
        "blur_score": 0.8
      }
    }
    ```

### 3.2. Требования к среде выполнения
*   **Язык:** Python 3.9+.
*   **Платформа:** Docker-контейнер (совместимый с Linux/macOS).
*   **Зависимости:** `opencv-python`, `mediapipe` / `insightface`, `numpy`, `fastapi` (или аналоги).

---

## 4. Данные

### 4.1. Источники данных
1.  **Примеры лица:** Открытый датасет **FFHQ** (Flickr-Faces-HQ) — 1000 изображений высокого качества.
2.  **Синтетические примеры лица:** Генерация аугментаций на базе FFHQ:
    *   Gaussian Blur (размытие).
    *   Brightness adjustment (затемнение/засвет).
    *   Random rotation (повороты).
    *   Overlay (наложение черных прямоугольников/масок).
3.  **Примеры атрибутов:** Датасет **CelebA** (атрибуты: очки, шляпы).

### 4.2. Права и конфиденциальность
*   Используются только открытые датасеты с лицензией, допускающей использование в научных целях (Creative Commons, MIT).
*   Никакие реальные биометрические данные пользователей библиотеки не используются для обучения.

---

## 5. Тестирование

Система считается готовой, если проходит следующий сценарий тестирования на отложенной выборке (Из 200 фото):

| ID Теста | Входные данные | Ожидаемый результат | Критерий успеха |
| :--- | :--- | :--- | :--- |
| **T-01** | Идеальное фото анфас (FFHQ) | `is_valid: true`, `errors: []` | Accuracy ≥ 95% |
| **T-02** | Фото без лица (пейзаж) | `is_valid: false`, `error: no_face` | Recall = 1.0 |
| **T-03** | Фото с сильным размытием | `is_valid: false`, `error: blurry` | Recall ≥ 85% |
| **T-04** | Фото в профиль (>30 град) | `is_valid: false`, `error: pose` | MAE ≤ 5° |
| **T-05** | Фото в темных очках | `is_valid: false`, `error: obscured` | F1-score ≥ 0.9 |
| **T-06** | Групповое фото (2+ лиц) | `is_valid: false`, `error: multiple_faces` | Recall ≥ 95% |