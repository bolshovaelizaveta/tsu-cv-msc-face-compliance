# Задание 3: Методы работы с данными

**Проект:** Проверка корректности фотографии лица пользователя при регистрации. 
**Цель:** Обеспечить модель качественными данными для обучения классификаторов дефектов и настройки порогов метрик.

## 1. Источники и сбор данных 

В условиях отсутствия профильного размеченного набора данных, выбрана стратегия **Data Synthesis & Augmentation**. Она подразумевает использование общедоступных наборов изображений высокого качества в качестве эталонных (позитивных) примеров и алгоритмическую генерацию негативных примеров (симуляция дефектов и несоответствий требованиям).

### 1.1. Открытые датасеты 
*   **FFHQ (Flickr-Faces-HQ):**
    *   Источник эталонных валидных изображений (высокое разрешение, анфас, хорошее освещение).
    *   Выборка из 5,000 изображений (разрешение 1024x1024).
    *   Лицензия: Creative Commons BY-NC-SA 4.0 (допустимо для исследовательских целей).
*   **CelebA (CelebFaces Attributes):**
    *   Источник данных для классификации атрибутов. Датасет содержит готовую разметку классов: `Eyeglasses` (очки), `Wearing_Hat` (головной убор), `Sideburns` (поворот/профиль).
    *   Выборка из 2,000 изображений, отобранных по целевым атрибутам.

### 1.2. Синтетическая генерация 
Для обучения детекции технических несоответствий (дефектов). Генерировать программно на базе датасета FFHQ.
*   **Имитация размытия (Blur simulation):** Применение Gaussian Blur с ядром переменного размера (от 3 до 15 px).
*   **Шумовые искажения (Noise injection):** Добавление гауссовского шума.
*   **Моделирование условий освещения:** Нелинейное изменение гаммы для создания эффектов пересвета и недостаточной освещенности.
*   **Геометрические искажения:** Имитация нарушения пропорций при масштабировании.

---

## 2. Предобработка 

1.  **Face Alignment:**
    *   Использование 5 ключевых точек лица (глаза, нос, уголки рта).
    *   Аффинное преобразование для приведения лица к каноническому виду. 
2.  **Кадрирование:**
    *   Вырезание области интереса с запасом 1.3x от размера детекции лица.
3.  **Ресайз и нормализация:**
    *   Приведение к размеру входа модели (например, 112x112 или 224x224 px).
    *   Нормализация значений пикселей к диапазону `[0, 1]` или стандартизация (Mean/Std ImageNet).
4.  **Фильтрация:**
    *   Исключение поврежденных файлов (битых заголовков).
    *   Удаление полных дубликатов (через перцептивный хэш).

---

## 3. Разметка 

Поскольку задача является мультиклассовой классификацией, используется следующая схема аннотации.

### 3.1. Инструментарий
*   **Автоматическая разметка:** Генератор данных автоматически присваивает метку класса в момент наложения эффекта (например, при наложении фильтра размытия изображение получает метку `class: blurry`).
*   **Ручная верификация:** Использование инструментов **Label Studio** или **CVAT** для выборочной проверки атрибутов из датасета CelebA (например, валидация типа очков).

### 3.2. Классы
Каждое изображение описывается вектором признаков:
*   `is_valid` (bool) — итоговый вердикт.
*   `has_glasses` (bool) — наличие очков.
*   `is_blurry` (bool) — наличие размытия.
*   `bad_lighting` (bool) — некорректное освещение.
*   `bad_pose` (bool) — отклонение угла головы выше порога.

---

## 4. Разбиение данных 

Используется схема **Train / Validation / Test** в пропорции **70% / 15% / 15%**.

### 4.1. Стратегия разбиения
*   **Stratified Split:** Обеспечение сбалансированного присутствия каждого класса дефектов во всех выборках.
*   **Grouped Split:** Все синтетические вариации, созданные из одного исходного изображения (одной личности), должны попадать строго в одну выборку. Это предотвращает утечку данных, когда модель учится узнавать конкретного человека, а не детектировать дефект.

---

## 5. Аугментация 

Необходимо разделять аугментацию для повышения обобщающей способности модели и аугментацию для генерации негативных классов.

### 5.1. Аугментации при обучении 
Применяются к классу "Valid" для повышения устойчивости, сохраняя статус "валидно":
*   **Horizontal Flip:** Отражение по горизонтали.
*   **Color Jitter (Minimal):** Незначительные колебания яркости/насыщенности (±5-10%).
*   **Shift/Scale:** Микро-сдвиги и масштабирование (имитация неидеального кадрирования).

### 5.2. Исключения
*   **Vertical Flip:** Не применяется (нефизично для портретного фото).
*   **Strong Blur/Noise:** Не применяются как аугментация для валидного класса, так как эти признаки являются критериями отказа.

---

## 6. Этика и законодательство

### 6.1. Авторские права и источники данных
Используемые наборы данных распространяются под лицензиями, допускающими их использование в некоммерческих исследовательских целях. В работе используются следующие источники:

*   **FFHQ (Flickr-Faces-HQ):**
    *   *Разработчик:* NVIDIA Labs.
    *   *Лицензия:* Creative Commons BY-NC-SA 4.0 (Attribution-NonCommercial-ShareAlike).
    *   *Ссылка:* [NVIDIA FFHQ Repository](https://github.com/NVlabs/ffhq-dataset)
    
*   **CelebA (CelebFaces Attributes):**
    *   *Разработчик:* Multimedia Lab (MMLAB), The Chinese University of Hong Kong.
    *   *Лицензия:* Non-commercial research purposes only.
    *   *Ссылка:* [CelebA Project Page](https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html)


### 6.2. Приватность (GDPR / 152-ФЗ)
*   В проекте не используются биометрические данные реальных пользователей библиотеки.
*   Архитектура системы (Privacy by Design) предполагает обработку данных в оперативной памяти (stateless) без сохранения изображений на постоянные носители.